<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DXF Length Calculator</title>
    <script src="dxf-parser-bundle.js"></script> <!-- Ensure this path is correct -->
</head>
<body>
    <h1>Upload DXF File</h1>
    <input type="file" id="fileInput" accept=".dxf" />
    <br><br>
    <div id="output"></div>

    <script>
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                parseDXF(content);
            };
            reader.readAsText(file);
        }

        function parseDXF(content) {
            const parser = new DxfParser();
            let dxf;

            try {
                dxf = parser.parseSync(content);
                const layers = extractLayers(dxf.entities);
                displayLayerLengths(layers);
            } catch (err) {
                console.error(err.stack);
                document.getElementById('output').textContent = "Error parsing DXF file.";
            }
        }

        function extractLayers(entities) {
            const layers = {};
            entities.forEach(entity => {
                const layerName = entity.layer;
                if (!layers[layerName]) {
                    layers[layerName] = 0;
                }
                if (entity.type === 'LINE' || entity.type === 'POLYLINE' || entity.type === 'SPLINE') {
                    const length = calculateLength(entity);
                    layers[layerName] += length;
                }
            });
            return layers;
        }

        function displayLayerLengths(layers) {
            const outputDiv = document.getElementById('output');
            outputDiv.innerHTML = ""; // Clear previous output

            for (const layer in layers) {
                const totalLength = layers[layer];
                outputDiv.innerHTML += `Total length for layer "${layer}": ${totalLength} units<br>`;
            }
        }

        function calculateLength(entity) {
            if (entity.type === 'LINE') {
                return calculateLineLength(entity);
            } else if (entity.type === 'POLYLINE') {
                return calculatePolylineLength(entity);
            } else if (entity.type === 'SPLINE') {
                return calculateSplineLength(entity);
            }
            return 0;
        }

        function calculateLineLength(line) {
            const start = line.vertices[0];
            const end = line.vertices[1];
            return Math.sqrt(Math.pow(end.x - start.x, 2) + Math.pow(end.y - start.y, 2));
        }

        function calculatePolylineLength(polyline) {
            let totalLength = 0;
            for (let i = 0; i < polyline.vertices.length - 1; i++) {
                const start = polyline.vertices[i];
                const end = polyline.vertices[i + 1];
                totalLength += Math.sqrt(Math.pow(end.x - start.x, 2) + Math.pow(end.y - start.y, 2));
            }
            return totalLength;
        }

        function calculateSplineLength(spline) {
            const controlPoints = spline.controlPoints;
            let totalLength = 0;

            // Number of segments to approximate the spline
            const numSegments = 100;

            for (let i = 0; i < numSegments; i++) {
                const t1 = i / numSegments;
                const t2 = (i + 1) / numSegments;

                const point1 = getSplinePoint(controlPoints, t1);
                const point2 = getSplinePoint(controlPoints, t2);

                totalLength += Math.sqrt(Math.pow(point2.x - point1.x, 2) + Math.pow(point2.y - point1.y, 2));
            }

            return totalLength;
        }

        function getSplinePoint(controlPoints, t) {
            const p0 = controlPoints[0];
            const p1 = controlPoints[1];
            const p2 = controlPoints[2];
            const p3 = controlPoints[3];

            const x = Math.pow(1 - t, 3) * p0.x + 
                      3 * Math.pow(1 - t, 2) * t * p1.x + 
                      3 * (1 - t) * Math.pow(t, 2) * p2.x + 
                      Math.pow(t, 3) * p3.x;

            const y = Math.pow(1 - t, 3) * p0.y + 
                      3 * Math.pow(1 - t, 2) * t * p1.y + 
                      3 * (1 - t) * Math.pow(t, 2) * p2.y + 
                      Math.pow(t, 3) * p3.y;

            return { x: x, y: y };
        }
    </script>
</body>
</html>
