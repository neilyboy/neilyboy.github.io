<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DXF/KML Length Calculator</title>
</head>
<body>
    <h1>Upload DXF/KML/KMZ File</h1>

    <!-- File input for DXF/KML/KMZ -->
    <input type="file" id="fileInput" accept=".dxf,.kml,.kmz" />
    <br><br>

    <div id="output"></div>

    <!-- dxf-parser library from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/dxf-parser@4.0.0/dist/dxf-parser.js"></script>
    
    <script>
        document.getElementById('fileInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            const fileExtension = file.name.split('.').pop().toLowerCase();

            if (fileExtension === 'dxf') {
                processDXF(file);
            } else if (fileExtension === 'kml' || fileExtension === 'kmz') {
                processKML(file);
            } else {
                document.getElementById('output').innerHTML = 'Unsupported file format. Please upload a DXF, KML, or KMZ file.';
            }
        });

        // Function to process DXF files
        function processDXF(file) {
            const reader = new FileReader();

            reader.onload = function (event) {
                const dxfString = event.target.result;
                const parser = new DxfParser();

                try {
                    const dxfData = parser.parseSync(dxfString);
                    const lengthsByLayer = {};

                    // Iterate over all entities
                    dxfData.entities.forEach(entity => {
                        if (entity.type === 'LINE' || entity.type === 'LWPOLYLINE' || entity.type === 'POLYLINE' || entity.type === 'SPLINE') {
                            const layer = entity.layer || 'default';
                            const length = calculateEntityLength(entity);

                            if (lengthsByLayer[layer]) {
                                lengthsByLayer[layer] += length;
                            } else {
                                lengthsByLayer[layer] = length;
                            }
                        }
                    });

                    displayLayerLengths(lengthsByLayer);
                } catch (err) {
                    console.error('Error parsing DXF:', err.message);
                    document.getElementById('output').innerHTML = 'Error parsing DXF file: ' + err.message;
                }
            };

            reader.readAsText(file);
        }

        // Function to calculate the length of a DXF entity
        function calculateEntityLength(entity) {
            let length = 0;

            if (entity.type === 'LINE') {
                const dx = entity.vertices[1].x - entity.vertices[0].x;
                const dy = entity.vertices[1].y - entity.vertices[0].y;
                length = Math.sqrt(dx * dx + dy * dy);
            } else if (entity.type === 'LWPOLYLINE' || entity.type === 'POLYLINE') {
                for (let i = 0; i < entity.vertices.length - 1; i++) {
                    const dx = entity.vertices[i + 1].x - entity.vertices[i].x;
                    const dy = entity.vertices[i + 1].y - entity.vertices[i].y;
                    length += Math.sqrt(dx * dx + dy * dy);
                }
            } else if (entity.type === 'SPLINE') {
                // Approximate the spline length by summing distances between control points
                const controlPoints = entity.controlPoints;
                for (let i = 0; i < controlPoints.length - 1; i++) {
                    const dx = controlPoints[i + 1].x - controlPoints[i].x;
                    const dy = controlPoints[i + 1].y - controlPoints[i].y;
                    length += Math.sqrt(dx * dx + dy * dy);
                }
            }

            return length;
        }

        // Function to display the calculated lengths for each layer
        function displayLayerLengths(lengthsByLayer) {
            const outputDiv = document.getElementById('output');
            outputDiv.innerHTML = '<h2>Layer Lengths (in drawing units)</h2>';
            const list = document.createElement('ul');

            Object.keys(lengthsByLayer).forEach(layer => {
                const listItem = document.createElement('li');
                listItem.textContent = `Layer: ${layer} - Total Length: ${lengthsByLayer[layer].toFixed(2)} units`;
                list.appendChild(listItem);
            });

            outputDiv.appendChild(list);
        }

        // Function to process KML/KMZ files
        function processKML(file) {
            const reader = new FileReader();

            reader.onload = function (event) {
                const kmlString = event.target.result;
                const parser = new DOMParser();
                const kmlDoc = parser.parseFromString(kmlString, 'application/vnd.google-earth.kml+xml');
                const placemarks = kmlDoc.getElementsByTagName('Placemark');
                let totalLength = 0;

                for (let i = 0; i < placemarks.length; i++) {
                    const coordinates = placemarks[i].getElementsByTagName('coordinates')[0];
                    if (coordinates) {
                        const coordsArray = coordinates.textContent.trim().split(' ').map(coord => coord.split(',').map(Number));
                        totalLength += calculateKMLLength(coordsArray);
                    }
                }

                document.getElementById('output').innerHTML = `Total length of all line segments: ${totalLength.toFixed(2)} units`;
            };

            reader.readAsText(file);
        }

        // Function to calculate the total length of a KML polyline
        function calculateKMLLength(coordsArray) {
            let length = 0;

            for (let i = 0; i < coordsArray.length - 1; i++) {
                const [x1, y1] = coordsArray[i];
                const [x2, y2] = coordsArray[i + 1];
                const dx = x2 - x1;
                const dy = y2 - y1;
                length += Math.sqrt(dx * dx + dy * dy);
            }

            return length;
        }
    </script>
</body>
</html>
